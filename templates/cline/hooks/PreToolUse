#!/usr/bin/env bash
# Security hook for Cline's PreToolUse
# Receives JSON on stdin with tool_name and tool_input
# Returns JSON on stdout:
#   Allow:  {} (empty object or no output)
#   Block:  {"cancel":true,"contextModification":"reason message"}
#
# Template variables:
#   __PROJECT_NAME__ - replaced with project name during installation

set -euo pipefail

# --- Read hook input from stdin ---
INPUT=$(cat)
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // empty' 2>/dev/null)

# Only process shell/command tool calls
case "$TOOL_NAME" in
    execute_command|run_terminal_command|Bash) ;;
    *) echo '{}'; exit 0 ;;
esac

COMMAND=$(echo "$INPUT" | jq -r '.tool_input.command // .tool_input.content // empty' 2>/dev/null)
if [[ -z "$COMMAND" ]]; then
    echo '{}'
    exit 0
fi

# --- Audit logging ---
LOG_DIR="$HOME/.llmsec/logs"
LOG_FILE="$LOG_DIR/__PROJECT_NAME___audit.log"
mkdir -p "$LOG_DIR"

TIMESTAMP=$(date -u '+%Y-%m-%dT%H:%M:%SZ')

log_entry() {
    echo "$TIMESTAMP | $1 | $COMMAND" >> "$LOG_FILE"
}

allow() {
    log_entry "ALLOWED"
    echo '{}'
    exit 0
}

block() {
    log_entry "BLOCKED"
    local msg=$(echo "$1" | sed 's/"/\\"/g' | tr '\n' ' ')
    echo "{\"cancel\":true,\"contextModification\":\"$msg\"}"
    exit 0
}

# --- Data theft prevention ---

if echo "$COMMAND" | grep -qiE '(curl|wget|http).*(pastebin\.com|transfer\.sh|file\.io|paste\.ee|hastebin|0x0\.st|ix\.io)'; then
    block "BLOCKED: Data exfiltration attempt. Write output to a local file instead."
fi

if echo "$COMMAND" | grep -qiE 'base64.*(\.env|credentials|_key\.pem|id_rsa|id_ed25519|\.aws)'; then
    block "BLOCKED: Encoding sensitive file. Use environment variables instead."
fi

if echo "$COMMAND" | grep -qiE '(cat|tar|zip|gzip|7z)\s.*(\.env|\.ssh/|\.aws/|credentials|_key\.pem|id_rsa|id_ed25519|\.gnupg)'; then
    block "BLOCKED: Access to sensitive file. Use environment variables instead."
fi

if echo "$COMMAND" | grep -qiE '(scp|rsync)\s.*(\.env|\.ssh|\.aws|credentials|_key\.pem)'; then
    block "BLOCKED: Transfer of sensitive files. Use secure secret management."
fi

# --- Dangerous patterns ---

if echo "$COMMAND" | grep -qE '(^|\s|;|&&|\|)rm\s+(-[a-zA-Z]*r[a-zA-Z]*f?|(-[a-zA-Z]*f[a-zA-Z]*)?-[a-zA-Z]*r)\s'; then
    block "BLOCKED: Recursive delete. Move to trash instead: mv <path> /tmp/trash/"
fi

if echo "$COMMAND" | grep -qE '(^|\s|;|&&|\|)sudo\s'; then
    block "BLOCKED: sudo not allowed. Work within current user permissions."
fi

if echo "$COMMAND" | grep -qE 'chmod\s+777'; then
    block "BLOCKED: chmod 777 not allowed. Use chmod 644 or 755 instead."
fi

if echo "$COMMAND" | grep -qE '(^|\s|;|&&|\|)dd\s'; then
    block "BLOCKED: dd not allowed. Use cp for file copying."
fi

if echo "$COMMAND" | grep -qE 'git\s+push\s+.*(-f|--force)'; then
    block "BLOCKED: Force push not allowed. Use regular git push."
fi

# --- Command allowed ---
allow
